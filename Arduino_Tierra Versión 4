// ==============================
// üåç ESTACI√ìN TIERRA v3 - PUENTE + LCD AMENAZA
// ==============================

#include <SoftwareSerial.h>
#include <LiquidCrystal.h>

// Pines LCD en estaci√≥n tierra
#define LCD_RS 3
#define LCD_E  4
#define LCD_D4 5
#define LCD_D5 6
#define LCD_D6 7
#define LCD_D7 8

SoftwareSerial satSerial(10, 11); // RX, TX hacia sat√©lite
LiquidCrystal lcd(LCD_RS, LCD_E, LCD_D4, LCD_D5, LCD_D6, LCD_D7);

const int ledRx     = 12;
const int ledAlerta = 13;

unsigned long ultimoMensaje = 0;
const unsigned long TIMEOUT_COMUNICACION = 15000;

bool alertaDHTActiva     = false;
bool alertaUltraActiva   = false;
bool alertaTimeoutActiva = false;
bool amenazaActiva       = false;  // ‚Üê LCD amenaza

void setup() {
  pinMode(ledRx, OUTPUT);
  pinMode(ledAlerta, OUTPUT);

  Serial.begin(9600);     // PC / Python
  satSerial.begin(9600);  // Sat√©lite

  // Inicializar LCD
  lcd.begin(16, 2);
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("ESTACION TIERRA");
  lcd.setCursor(0, 1);
  lcd.print("Esperando sat...");

  Serial.println("BRIDGE: Estaci√≥n de Tierra lista");
  ultimoMensaje = millis();
}

void loop() {
  // 1Ô∏è‚É£ RECEPCI√ìN DESDE SAT√âLITE
  if (satSerial.available()) {
    String data = satSerial.readStringUntil('\n');
    data.trim();
    if (!data.length()) return;

    ultimoMensaje = millis();
    digitalWrite(ledRx, HIGH);
    delay(20);
    digitalWrite(ledRx, LOW);

    if (alertaTimeoutActiva) {
      alertaTimeoutActiva = false;
      Serial.println("BRIDGE: ‚úÖ Comunicaci√≥n recuperada");
      lcd.clear();
      lcd.setCursor(0, 0);
      lcd.print("SAT RECONECTADO");
    }

    // AMENAZA DESDE SAT√âLITE ‚Üí LCD LOCAL
    if (data.indexOf("5:AMENAZA_ON") != -1) {
      if (!amenazaActiva) {
        amenazaActiva = true;
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("*** AMENAZA ***");
        lcd.setCursor(0, 1);
        lcd.print("Objeto <50cm");
        Serial.println("BRIDGE: ‚ö†Ô∏è AMENAZA detectada");
      }
    } else if (data.indexOf("5:AMENAZA_OFF") != -1) {
      if (amenazaActiva) {
        amenazaActiva = false;
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("AREA SEGURA");
        lcd.setCursor(0, 1);
        lcd.print("Todo OK");
        Serial.println("BRIDGE: ‚úÖ Amenaza resuelta");
      }
    }
    // Fallos sensores
    else if (data.startsWith("3:")) {
      if (!alertaDHTActiva) {
        alertaDHTActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è Fallo DHT");
      }
      Serial.println(data);
    }
    else if (data.startsWith("6:")) {
      if (!alertaUltraActiva) {
        alertaUltraActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è Fallo ultrasonido");
      }
      Serial.println(data);
    }
    else {
      // Reset alertas sensores
      if (alertaDHTActiva) {
        alertaDHTActiva = false;
        Serial.println("BRIDGE: ‚úÖ DHT recuperado");
      }
      if (alertaUltraActiva) {
        alertaUltraActiva = false;
        Serial.println("BRIDGE: ‚úÖ Ultrasonido recuperado");
      }
      Serial.println(data);  // Reenv√≠a al PC
    }
  }

  // 2Ô∏è‚É£ TIMEOUT
  if (!alertaTimeoutActiva && millis() - ultimoMensaje > TIMEOUT_COMUNICACION) {
    alertaTimeoutActiva = true;
    Serial.println("BRIDGE: ‚ö†Ô∏è Sin comunicaci√≥n sat√©lite");
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("SATELITE PERDIDO");
  }

  // 3Ô∏è‚É£ LED alerta global
  if (alertaDHTActiva || alertaUltraActiva || alertaTimeoutActiva || amenazaActiva) {
    digitalWrite(ledAlerta, HIGH);
  } else {
    digitalWrite(ledAlerta, LOW);
  }

  // 4Ô∏è‚É£ COMANDOS PC ‚Üí SAT√âLITE
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.length() > 0) {
      satSerial.println(cmd);
    }
  }
}
