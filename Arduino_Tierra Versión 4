// ==============================
// üåç ESTACI√ìN TIERRA - PUENTE LIMPIO v2 + AMENAZA
// ==============================

#include <SoftwareSerial.h>

SoftwareSerial satSerial(10, 11); // RX, TX hacia sat√©lite

const int ledRx     = 12;
const int ledAlerta = 13;

unsigned long ultimoMensaje = 0;
const unsigned long TIMEOUT_COMUNICACION = 15000;

bool alertaDHTActiva     = false;
bool alertaUltraActiva   = false;
bool alertaTimeoutActiva = false;
bool alertaAmenazaActiva = false;   // NUEVO

void setup() {
  pinMode(ledRx, OUTPUT);
  pinMode(ledAlerta, OUTPUT);

  Serial.begin(9600);     // PC / Python
  satSerial.begin(9600);  // Sat√©lite

  Serial.println("BRIDGE: Estaci√≥n de Tierra lista");
  ultimoMensaje = millis();
}

void loop() {

  // 1Ô∏è‚É£ RECEPCI√ìN DESDE EL SAT√âLITE
  if (satSerial.available()) {
    String data = satSerial.readStringUntil('\n');
    data.trim();
    if (!data.length()) return;

    ultimoMensaje = millis();

    digitalWrite(ledRx, HIGH);
    delay(20);
    digitalWrite(ledRx, LOW);

    if (alertaTimeoutActiva) {
      alertaTimeoutActiva = false;
      Serial.println("BRIDGE: ‚úÖ Comunicaci√≥n con sat√©lite recuperada");
    }

    // ---- FALLO DHT ----
    if (data.startsWith("3:")) {
      if (!alertaDHTActiva) {
        alertaDHTActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è Fallo sensor DHT");
      }
      Serial.println(data);
    }
    // ---- FALLO ULTRASONIDO ----
    else if (data.startsWith("6:")) {
      if (!alertaUltraActiva) {
        alertaUltraActiva = true;
        Serial.println("BRIDGE: ‚ö†Ô∏è Fallo sensor ultrasonido");
      }
      Serial.println(data);
    }
    else {
      // ---- AMENAZA ON / OFF DESDE SAT√âLITE ----
      if (data.indexOf("5:AMENAZA_ON") != -1) {
        if (!alertaAmenazaActiva) {
          alertaAmenazaActiva = true;
          Serial.println("BRIDGE: ‚ö†Ô∏è AMENAZA detectada");
        }
      } else if (data.indexOf("5:AMENAZA_OFF") != -1) {
        if (alertaAmenazaActiva) {
          alertaAmenazaActiva = false;
          Serial.println("BRIDGE: ‚úÖ Amenaza resuelta");
        }
      }

      // Reset de alertas de sensores si llegan datos normales
      if (alertaDHTActiva && !data.startsWith("3:")) {
        alertaDHTActiva = false;
        Serial.println("BRIDGE: ‚úÖ Sensor DHT recuperado");
      }
      if (alertaUltraActiva && !data.startsWith("6:")) {
        alertaUltraActiva = false;
        Serial.println("BRIDGE: ‚úÖ Sensor ultrasonido recuperado");
      }

      // Reenviar TAL CUAL lo que venga del sat√©lite (incluye CHK:...)
      Serial.println(data);
    }
  }

  // 2Ô∏è‚É£ TIMEOUT
  if (!alertaTimeoutActiva &&
      millis() - ultimoMensaje > TIMEOUT_COMUNICACION) {

    alertaTimeoutActiva = true;
    Serial.println("BRIDGE: ‚ö†Ô∏è Sin comunicaci√≥n con el sat√©lite");
  }

  // 3Ô∏è‚É£ LED alerta global (incluye amenaza)
  if (alertaDHTActiva || alertaUltraActiva || alertaTimeoutActiva || alertaAmenazaActiva) {
    digitalWrite(ledAlerta, HIGH);
  } else {
    digitalWrite(ledAlerta, LOW);
  }

  // 4Ô∏è‚É£ COMANDOS DESDE PYTHON ‚Üí SAT√âLITE
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.length() > 0) {
      satSerial.println(cmd);
    }
  }
}
