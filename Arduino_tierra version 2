//ESTACION TIERRA

#include <SoftwareSerial.h>

SoftwareSerial satSerial(10, 11); // RX, TX hacia satÃ©lite

const int ledRx = 12;     // LED que parpadea al recibir datos
const int ledAlerta = 13; // LED de alerta (fallo sensor)

unsigned long ultimoMensaje = 0;
const unsigned long timeout = 5000; // 5 segundos sin mensaje -> alerta

void setup() {
  pinMode(ledRx, OUTPUT);
  pinMode(ledAlerta, OUTPUT);
  
  Serial.begin(9600);     // ComunicaciÃ³n con la interfaz Python
  satSerial.begin(9600);  // ComunicaciÃ³n con el satÃ©lite

  Serial.println("EstaciÃ³n de Tierra lista");
  ultimoMensaje = millis();
}

void loop() {
  // 1ï¸âƒ£ RecepciÃ³n de datos del satÃ©lite
  if (satSerial.available()) {
    String data = satSerial.readStringUntil('\n');
    data.trim();

    // Actualiza tiempo del Ãºltimo mensaje
    ultimoMensaje = millis();

    // ðŸ”¹ LED parpadeo recepciÃ³n
    digitalWrite(ledRx, HIGH);
    delay(50);
    digitalWrite(ledRx, LOW);

    // ðŸ”¸ Analizar mensajes de fallo/alerta
    // Fallo DHT
    if (data.startsWith("3:")) {
      digitalWrite(ledAlerta, HIGH);
      Serial.println("âš ï¸ Fallo sensor DHT");
    }
    // Fallo distancia
    else if (data.startsWith("6:")) {
      digitalWrite(ledAlerta, HIGH);
      Serial.println("âš ï¸ Fallo sensor ultrasonido");
    }
    // Mensaje normal de DHT o ultrasonido
    else {
      digitalWrite(ledAlerta, LOW);
      Serial.println(data); // reenvÃ­a todos los datos al Python
    }
  }

  // 2ï¸âƒ£ Timeout: si no llega nada desde el satÃ©lite
  if (millis() - ultimoMensaje > timeout) {
    digitalWrite(ledAlerta, HIGH);
    Serial.println("âš ï¸ Sin comunicaciÃ³n con el satÃ©lite");
  }

  // 3ï¸âƒ£ ReenvÃ­o de comandos desde interfaz hacia el satÃ©lite
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.length() > 0) {
      satSerial.println(cmd);
    }
  }
}
